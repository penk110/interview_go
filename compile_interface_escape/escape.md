### 1.查看内存分配

```
benchmark 查看内存分配 --benchmem

不同版本表现不一致，1.16中优化过？
 go test --bench=. -benchmem

➜  compile_interface_escape git:(master) ✗ go1.14.12 test --bench=BenchmarkRectangle_Area2 -benchmem
goos: darwin
goarch: amd64
pkg: github.com/penk110/interview_go/compile_interface_escape
BenchmarkRectangle_Area2-12     48553300                22.3 ns/op            16 B/op          1 allocs/op
PASS
ok      github.com/penk110/interview_go/compile_interface_escape        1.199s
➜  compile_interface_escape git:(master) ✗ go115 test --bench=BenchmarkRectangle_Area2 -benchmem
goos: darwin
goarch: amd64
pkg: github.com/penk110/interview_go/compile_interface_escape
BenchmarkRectangle_Area2-12     55953272                21.3 ns/op            16 B/op          1 allocs/op
PASS
ok      github.com/penk110/interview_go/compile_interface_escape        2.356s
➜  compile_interface_escape git:(master) ✗ go1.16 test --bench=BenchmarkRectangle_Area2 -benchmem
goos: darwin
goarch: amd64
pkg: github.com/penk110/interview_go/compile_interface_escape
cpu: Intel(R) Core(TM) i7-9750H CPU @ 2.60GHz
BenchmarkRectangle_Area2-12     512077160                2.229 ns/op           0 B/op          0 allocs/op
PASS
ok      github.com/penk110/interview_go/compile_interface_escape        1.466s

```

##### 逃逸分析

Go1.14.12 逃逸到堆中

```

➜  compile_interface_escape git:(master) ✗ go1.14.12 tool compile -m interface_escape.go
interface_escape.go:18:6: can inline main
interface_escape.go:28:12: Shape(r) escapes to heap
<autogenerated>:1: .this does not escape
<autogenerated>:1: leaking param: .this

```



### 2.接口调用分析

```

➜  compile_interface_escape git:(master) ✗ go1.14.12 test --bench=. -benchmem                              
goos: darwin
goarch: amd64
pkg: github.com/penk110/interview_go/compile_interface_escape
BenchmarkRectangle_Area-12      1000000000               0.257 ns/op           0 B/op          0 allocs/op
BenchmarkRectangle_Area2-12     47490686                22.7 ns/op            16 B/op          1 allocs/op
PASS
ok      github.com/penk110/interview_go/compile_interface_escape        1.729s


直接调用：
	0.257 ns/op  
接口调用：
	22.7 ns/op  
```



##### 尝试编译禁止编译器优化

```

// Area 标记禁止函数内联
//go:noinline
func (rectangle Rectangle) Area() float64 {
	return rectangle.a * rectangle.b
}

// Go1.14.12 Go1.15 消除函数内联前后差别不大
➜  compile_interface_escape git:(master) ✗ go115 test --bench=.                             
goos: darwin
goarch: amd64
pkg: github.com/penk110/interview_go/compile_interface_escape
BenchmarkRectangle_Area-12      691272598                1.61 ns/op
BenchmarkRectangle_Area2-12     48502626                22.4 ns/op
PASS
ok      github.com/penk110/interview_go/compile_interface_escape        2.674s


// Go1.16 消除函数内联前
➜  compile_interface_escape git:(master) ✗ go1.16 test --bench=.
goos: darwin
goarch: amd64
pkg: github.com/penk110/interview_go/compile_interface_escape
cpu: Intel(R) Core(TM) i7-9750H CPU @ 2.60GHz
BenchmarkRectangle_Area-12      1000000000               0.2578 ns/op
BenchmarkRectangle_Area2-12     736187778                1.615 ns/op
PASS
ok      github.com/penk110/interview_go/compile_interface_escape        1.980s

// Go1.16 消除函数内联后
➜  compile_interface_escape git:(master) ✗ go1.16 test --bench=.
goos: darwin
goarch: amd64
pkg: github.com/penk110/interview_go/compile_interface_escape
cpu: Intel(R) Core(TM) i7-9750H CPU @ 2.60GHz
BenchmarkRectangle_Area-12      689296582                1.623 ns/op
BenchmarkRectangle_Area2-12     731379114                1.615 ns/op

```



##### 指针接受者时

##### 1)消除函数内联前后在Go1.14.12版本中benchmark具体表现

```
➜  compile_interface_escape_ptr_reciver git:(master) ✗ go1.14.12 test --bench=. -benchmem  
goos: darwin
goarch: amd64
pkg: github.com/penk110/interview_go/compile_interface_escape_ptr_reciver
BenchmarkRectangle_Area-12      1000000000               0.253 ns/op           0 B/op          0 allocs/op
BenchmarkRectangle_Area2-12     816028224                1.44 ns/op            0 B/op          0 allocs/op
PASS
ok      github.com/penk110/interview_go/compile_interface_escape_ptr_reciver    1.994s
➜  compile_interface_escape_ptr_reciver git:(master) ✗ go1.14.12 test --bench=. -benchmem
goos: darwin
goarch: amd64
pkg: github.com/penk110/interview_go/compile_interface_escape_ptr_reciver
BenchmarkRectangle_Area-12      924217684                1.29 ns/op            0 B/op          0 allocs/op
BenchmarkRectangle_Area2-12     827911250                1.44 ns/op            0 B/op          0 allocs/op
PASS
ok      github.com/penk110/interview_go/compile_interface_escape_ptr_reciver    2.762s

```

##### 2) 消除函数内联前后在Go1.6版本中benchmark具体表现

```
➜  compile_interface_escape_ptr_reciver git:(master) ✗ go1.16 test --bench=. -benchmem
goos: darwin
goarch: amd64
pkg: github.com/penk110/interview_go/compile_interface_escape_ptr_reciver
cpu: Intel(R) Core(TM) i7-9750H CPU @ 2.60GHz
BenchmarkRectangle_Area-12      1000000000               0.2547 ns/op          0 B/op          0 allocs/op
BenchmarkRectangle_Area2-12     917150472                1.292 ns/op           0 B/op          0 allocs/op
PASS
ok      github.com/penk110/interview_go/compile_interface_escape_ptr_reciver    1.873s
➜  compile_interface_escape_ptr_reciver git:(master) ✗ go1.16 test --bench=. -benchmem
goos: darwin
goarch: amd64
pkg: github.com/penk110/interview_go/compile_interface_escape_ptr_reciver
cpu: Intel(R) Core(TM) i7-9750H CPU @ 2.60GHz
BenchmarkRectangle_Area-12      849282498                1.416 ns/op           0 B/op          0 allocs/op
BenchmarkRectangle_Area2-12     916650000                1.284 ns/op           0 B/op          0 allocs/op
PASS
ok      github.com/penk110/interview_go/compile_interface_escape_ptr_reciver    2.748s

```



### PS：部分汇编代码(具体看源码)

```asm
// 调用runtime.morestack_noctxt执行栈扩容
// morestack but not preserving ctxt.
TEXT runtime·morestack_noctxt(SB),NOSPLIT,$0
	MOVL	$0, DX
	JMP	runtime·morestack(SB)
	


```



```
        从内存读取
        0x001d 00029 (interface_escape.go:23)   LEAQ    type."".Rectangle(SB), AX
        0x0024 00036 (interface_escape.go:23)   MOVQ    AX, (SP)
        0x0028 00040 (interface_escape.go:23)   PCDATA  $1, $0
        新建对象
        0x0028 00040 (interface_escape.go:23)   CALL    runtime.newobject(SB)
        0x002d 00045 (interface_escape.go:23)   MOVQ    8(SP), AX
        拷贝
        0x0032 00050 (interface_escape.go:24)   MOVSD   $f64.4024000000000000(SB), X0
        0x003a 00058 (interface_escape.go:24)   MOVSD   X0, (AX)
        0x003e 00062 (interface_escape.go:25)   MOVSD   $f64.4034000000000000(SB), X0
        0x0046 00070 (interface_escape.go:25)   MOVSD   X0, 8(AX)
        0x004b 00075 (interface_escape.go:30)   LEAQ    go.itab.*"".Rectangle,"".Shape(SB), CX
        0x0052 00082 (interface_escape.go:30)   TESTB   AL, (CX)
        0x0054 00084 (interface_escape.go:30)   MOVQ    AX, (SP)
        接口调用
        0x0058 00088 (interface_escape.go:30)   CALL    "".(*Rectangle).Area(SB)
        0x005d 00093 (interface_escape.go:31)   MOVQ    16(SP), BP
        0x0062 00098 (interface_escape.go:31)   ADDQ    $24, SP
        0x0066 00102 (interface_escape.go:31)   RET
        0x0067 00103 (interface_escape.go:31)   NOP
        0x0067 00103 (interface_escape.go:18)   PCDATA  $1, $-1
        0x0067 00103 (interface_escape.go:18)   PCDATA  $0, $-2
        触发栈扩容
        0x0067 00103 (interface_escape.go:18)   CALL    runtime.morestack_noctxt(SB)
        0x006c 00108 (interface_escape.go:18)   PCDATA  $0, $-1
        跳转
        0x006c 00108 (interface_escape.go:18)   JMP     0

```



##### 结论(未完)

```
执行接口动态调用尽量使用指针

```



---

##### 参考

```
https://zhuanlan.zhihu.com/p/28409657
https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-stack-management/

```

